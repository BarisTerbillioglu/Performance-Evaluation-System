# JWT Authentication System Guide\n\nThis guide documents the complete JWT authentication system implemented for the Performance Evaluation System frontend.\n\n## üîê Overview\n\nThe authentication system provides:\n- JWT token-based authentication with HTTP-only cookies\n- Role-based access control (RBAC)\n- Automatic token refresh\n- Comprehensive form validation with Zod\n- Protected routes and components\n- Loading states and error handling\n- Role-based redirects after login\n\n## üèóÔ∏è Architecture\n\n### Core Components\n\n1. **AuthContext & Provider** (`src/store/authStore.tsx`)\n2. **ProtectedRoute Components** (`src/components/auth/ProtectedRoute.tsx`)\n3. **Login Page with Validation** (`src/pages/auth/LoginPage.tsx`)\n4. **RBAC Utilities** (`src/utils/rbac.ts`)\n5. **Form Validation Schemas** (`src/utils/validation.ts`)\n\n## üöÄ Features Implemented\n\n### 1. JWT Authentication with HTTP-Only Cookies\n\n```typescript\n// API client automatically handles cookies\nconst api = axios.create({\n  baseURL: CONFIG.API_BASE_URL,\n  withCredentials: true, // Enable HTTP-only cookies\n});\n```\n\n**Benefits:**\n- Secure token storage (XSS protection)\n- Automatic token inclusion in requests\n- Server-side cookie management\n\n### 2. Enhanced AuthContext\n\n```typescript\ninterface AuthContextType {\n  state: AuthState;\n  login: (credentials: LoginRequest) => Promise<void>;\n  logout: () => Promise<void>;\n  refreshAuth: () => Promise<void>;\n  checkAuth: () => Promise<void>;\n  hasRole: (role: UserRole) => boolean;\n  hasPermission: (resource: string, action: string) => boolean;\n  canAccessRoute: (path: string) => boolean;\n  clearError: () => void;\n}\n```\n\n**Features:**\n- Automatic token refresh every 14 minutes\n- Role-based permission checking\n- Error state management\n- Loading and initialization states\n\n### 3. Role-Based Access Control (RBAC)\n\n#### Supported Roles:\n- `ADMIN` - Full system access\n- `MANAGER` - Team and evaluation management\n- `HR` - User and department management\n- `EVALUATOR` - Evaluation scoring\n- `EMPLOYEE` - Basic access\n\n#### Permission System:\n```typescript\nexport const ROLE_PERMISSIONS: RolePermissions = {\n  [UserRole.ADMIN]: [\n    { resource: 'users', actions: ['create', 'read', 'update', 'delete'] },\n    { resource: 'evaluations', actions: ['create', 'read', 'update', 'delete'] },\n    // ... more permissions\n  ],\n  // ... other roles\n};\n```\n\n#### Route Protection:\n```typescript\nexport const ROUTE_ACCESS: RouteAccess[] = [\n  { path: '/admin', roles: [UserRole.ADMIN] },\n  { path: '/users', roles: [UserRole.ADMIN, UserRole.HR] },\n  // ... more routes\n];\n```\n\n### 4. Protected Route Components\n\n#### Basic Protection:\n```typescript\n<ProtectedRoute>\n  <DashboardPage />\n</ProtectedRoute>\n```\n\n#### Role-Based Protection:\n```typescript\n<ProtectedRoute requiredRoles={[UserRole.ADMIN, UserRole.HR]}>\n  <UsersPage />\n</ProtectedRoute>\n```\n\n#### Permission-Based Protection:\n```typescript\n<ProtectedRoute requiredPermission={{ resource: 'users', action: 'create' }}>\n  <CreateUserForm />\n</ProtectedRoute>\n```\n\n### 5. Component-Level Guards\n\n#### Role Guard:\n```typescript\n<RoleGuard roles={[UserRole.ADMIN]} fallback={<div>Access Denied</div>}>\n  <AdminControls />\n</RoleGuard>\n```\n\n#### Permission Guard:\n```typescript\n<PermissionGuard resource=\"users\" action=\"delete\" fallback={null}>\n  <DeleteButton />\n</PermissionGuard>\n```\n\n### 6. HOC Protection\n\n```typescript\n// Protect component with roles\nconst ProtectedAdminPanel = withRoleProtection(AdminPanel, [UserRole.ADMIN]);\n\n// Protect component with permissions\nconst ProtectedUserForm = withPermissionProtection(UserForm, 'users', 'create');\n```\n\n### 7. Form Validation with Zod\n\n#### Login Form Schema:\n```typescript\nexport const loginSchema = z.object({\n  email: z\n    .string()\n    .min(1, 'Email is required')\n    .email('Please enter a valid email address'),\n  password: z\n    .string()\n    .min(1, 'Password is required')\n    .min(8, 'Password must be at least 8 characters'),\n  rememberMe: z.boolean().default(false)\n});\n```\n\n#### Usage with React Hook Form:\n```typescript\nconst {\n  register,\n  handleSubmit,\n  formState: { errors, isSubmitting },\n} = useForm<LoginFormData>({\n  resolver: zodResolver(loginSchema),\n});\n```\n\n### 8. Automatic Token Refresh\n\n```typescript\n// Auto-refresh token every 14 minutes\nuseEffect(() => {\n  if (!state.isAuthenticated) return;\n\n  const refreshInterval = setInterval(async () => {\n    try {\n      await refreshAuth();\n    } catch (error) {\n      console.error('Auto-refresh failed:', error);\n    }\n  }, 14 * 60 * 1000); // 14 minutes\n\n  return () => clearInterval(refreshInterval);\n}, [state.isAuthenticated, refreshAuth]);\n```\n\n### 9. Role-Based Redirects\n\n```typescript\nexport const ROLE_REDIRECT_PATHS: Record<UserRole, string> = {\n  [UserRole.ADMIN]: '/admin',\n  [UserRole.EVALUATOR]: '/evaluations',\n  [UserRole.EMPLOYEE]: '/dashboard',\n  [UserRole.MANAGER]: '/evaluations',\n  [UserRole.HR]: '/users'\n};\n```\n\n### 10. Loading States & Error Handling\n\n#### Loading States:\n- `isLoading` - API operations in progress\n- `isInitialized` - Auth system initialization complete\n- Form submission states\n\n#### Error Handling:\n- Field-specific validation errors\n- API error messages\n- Network error handling\n- Automatic error clearing\n\n## üì± Usage Examples\n\n### 1. Using Auth in Components\n\n```typescript\nimport { useAuth } from '@/store';\n\nconst MyComponent = () => {\n  const { state, hasRole, hasPermission, logout } = useAuth();\n\n  if (state.isLoading) {\n    return <LoadingSpinner />;\n  }\n\n  if (!state.isAuthenticated) {\n    return <div>Please log in</div>;\n  }\n\n  return (\n    <div>\n      <h1>Welcome, {state.user?.firstName}!</h1>\n      {hasRole(UserRole.ADMIN) && <AdminPanel />}\n      {hasPermission('users', 'create') && <CreateUserButton />}\n      <button onClick={logout}>Logout</button>\n    </div>\n  );\n};\n```\n\n### 2. Creating Protected Pages\n\n```typescript\nimport { ProtectedRoute } from '@/components/auth';\nimport { UserRole } from '@/types/roles';\n\nconst AdminPage = () => (\n  <ProtectedRoute requiredRoles={[UserRole.ADMIN]}>\n    <AdminDashboard />\n  </ProtectedRoute>\n);\n```\n\n### 3. Conditional Menu Items\n\n```typescript\nconst menuItems: MenuItem[] = [\n  {\n    path: '/dashboard',\n    label: 'Dashboard',\n  },\n  {\n    path: '/users',\n    label: 'Users',\n    requiredRoles: [UserRole.ADMIN, UserRole.HR],\n  },\n];\n\nconst allowedMenuItems = filterMenuItems(state.user, menuItems);\n```\n\n### 4. Form Validation\n\n```typescript\nimport { useForm } from 'react-hook-form';\nimport { zodResolver } from '@hookform/resolvers/zod';\nimport { loginSchema, LoginFormData } from '@/utils/validation';\n\nconst LoginForm = () => {\n  const {\n    register,\n    handleSubmit,\n    formState: { errors, isSubmitting },\n  } = useForm<LoginFormData>({\n    resolver: zodResolver(loginSchema),\n  });\n\n  const onSubmit = async (data: LoginFormData) => {\n    try {\n      await login(data);\n    } catch (error) {\n      // Handle error\n    }\n  };\n\n  return (\n    <form onSubmit={handleSubmit(onSubmit)}>\n      <input\n        {...register('email')}\n        type=\"email\"\n        className={errors.email ? 'border-red-300' : 'border-gray-300'}\n      />\n      {errors.email && <span>{errors.email.message}</span>}\n      \n      <input\n        {...register('password')}\n        type=\"password\"\n        className={errors.password ? 'border-red-300' : 'border-gray-300'}\n      />\n      {errors.password && <span>{errors.password.message}</span>}\n      \n      <button type=\"submit\" disabled={isSubmitting}>\n        {isSubmitting ? 'Signing in...' : 'Sign in'}\n      </button>\n    </form>\n  );\n};\n```\n\n## üîß Configuration\n\n### Environment Variables\n```env\nVITE_API_BASE_URL=http://localhost:5282\n```\n\n### Backend Requirements\n\nYour .NET API should:\n\n1. **Set HTTP-only cookies:**\n```csharp\nvar cookieOptions = new CookieOptions\n{\n    HttpOnly = true,\n    Secure = false, // Set to true in production with HTTPS\n    SameSite = SameSiteMode.Lax,\n    Expires = DateTime.UtcNow.AddMinutes(15)\n};\n\nResponse.Cookies.Append(\"accessToken\", accessToken, cookieOptions);\n```\n\n2. **Enable CORS with credentials:**\n```csharp\nservices.AddCors(options => {\n  options.AddPolicy(\"AllowCredentials\", builder => {\n    builder.WithOrigins(\"http://localhost:3000\")\n           .AllowCredentials()\n           .AllowAnyHeader()\n           .AllowAnyMethod();\n  });\n});\n```\n\n3. **Return user roles in login response:**\n```csharp\npublic class UserInfo\n{\n    public int Id { get; set; }\n    public string FirstName { get; set; }\n    public string LastName { get; set; }\n    public string Email { get; set; }\n    public int DepartmentID { get; set; }\n    public List<int> RoleIds { get; set; }\n    public List<string> Roles { get; set; } // Add this\n}\n```\n\n## üõ°Ô∏è Security Features\n\n1. **XSS Protection** - HTTP-only cookies prevent JavaScript access\n2. **CSRF Protection** - SameSite cookie attribute\n3. **Token Expiration** - Automatic refresh and logout\n4. **Route Protection** - Comprehensive access control\n5. **Input Validation** - Zod schema validation\n6. **Error Handling** - Secure error messages\n\n## üß™ Testing Authentication\n\n### Test Login Flow:\n1. Navigate to `/login`\n2. Enter valid credentials\n3. Verify redirect to appropriate dashboard based on role\n4. Check that navigation menu shows role-appropriate items\n5. Test protected route access\n\n### Test Role-Based Access:\n1. Login as different user types\n2. Verify access to role-specific pages\n3. Check that restricted content is hidden\n4. Test unauthorized access redirects\n\n### Test Token Refresh:\n1. Login and wait for auto-refresh (14 minutes)\n2. Verify continued access after refresh\n3. Test manual refresh on 401 errors\n\n## üêõ Troubleshooting\n\n### Common Issues:\n\n1. **Cookie not being set:**\n   - Check CORS configuration\n   - Verify `withCredentials: true` in API client\n   - Ensure backend sets cookies correctly\n\n2. **401 Unauthorized errors:**\n   - Check token expiration\n   - Verify cookie names match backend\n   - Check SameSite policy\n\n3. **Role-based access not working:**\n   - Verify user roles are returned from backend\n   - Check role mapping in `getUserPrimaryRole`\n   - Validate RBAC configuration\n\n4. **Form validation errors:**\n   - Check Zod schema definitions\n   - Verify react-hook-form integration\n   - Check error display logic\n\n## üìö Additional Resources\n\n- [React Hook Form Documentation](https://react-hook-form.com/)\n- [Zod Validation Library](https://github.com/colinhacks/zod)\n- [JWT Best Practices](https://auth0.com/blog/a-look-at-the-latest-draft-for-jwt-bcp/)\n- [HTTP-only Cookies Security](https://owasp.org/www-community/HttpOnly)\n\nThe authentication system is now fully implemented and ready for use! üéâ
