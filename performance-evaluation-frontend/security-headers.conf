# Security Headers Configuration for Performance Evaluation System
# Comprehensive security headers for production deployment

# Content Security Policy (CSP)
# Strict CSP to prevent XSS attacks
add_header Content-Security-Policy "
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
    font-src 'self' https://fonts.gstatic.com data:;
    img-src 'self' data: https: blob:;
    media-src 'self' https:;
    connect-src 'self' https://api.performance-evaluation.com wss: https://ws.performance-evaluation.com;
    frame-src 'self' https://www.google.com;
    frame-ancestors 'self';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    upgrade-insecure-requests;
" always;

# X-Frame-Options
# Prevent clickjacking attacks
add_header X-Frame-Options "SAMEORIGIN" always;

# X-Content-Type-Options
# Prevent MIME type sniffing
add_header X-Content-Type-Options "nosniff" always;

# X-XSS-Protection
# Enable XSS protection in older browsers
add_header X-XSS-Protection "1; mode=block" always;

# Referrer Policy
# Control referrer information
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Permissions Policy (formerly Feature Policy)
# Control browser features
add_header Permissions-Policy "
    accelerometer=(),
    ambient-light-sensor=(),
    autoplay=(),
    battery=(),
    camera=(),
    cross-origin-isolated=(),
    display-capture=(),
    document-domain=(),
    encrypted-media=(),
    execution-while-not-rendered=(),
    execution-while-out-of-viewport=(),
    fullscreen=(self),
    geolocation=(),
    gyroscope=(),
    keyboard-map=(),
    magnetometer=(),
    microphone=(),
    midi=(),
    navigation-override=(),
    payment=(),
    picture-in-picture=(),
    publickey-credentials-get=(),
    screen-wake-lock=(),
    sync-xhr=(),
    usb=(),
    web-share=(),
    xr-spatial-tracking=()
" always;

# Strict-Transport-Security (HSTS)
# Force HTTPS connections (only enable when SSL is configured)
# add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Cross-Origin Embedder Policy (COEP)
# Enable cross-origin isolation
add_header Cross-Origin-Embedder-Policy "require-corp" always;

# Cross-Origin Opener Policy (COOP)
# Prevent cross-origin popups
add_header Cross-Origin-Opener-Policy "same-origin" always;

# Cross-Origin Resource Policy (CORP)
# Control cross-origin resource loading
add_header Cross-Origin-Resource-Policy "same-origin" always;

# Origin-Agent-Cluster
# Enable origin agent cluster
add_header Origin-Agent-Cluster "?1" always;

# Cache-Control for sensitive pages
# Prevent caching of sensitive content
location ~ ^/(login|logout|admin|settings|profile) {
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
}

# Security headers for API endpoints
location /api/ {
    # Additional security for API endpoints
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    
    # Prevent caching of API responses
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
}

# Security headers for static assets
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    # Basic security headers for static assets
    add_header X-Content-Type-Options "nosniff" always;
    
    # Cache static assets aggressively
    add_header Cache-Control "public, max-age=31536000, immutable" always;
    add_header Vary "Accept-Encoding" always;
}

# Security headers for HTML files
location ~* \.html$ {
    # Prevent caching of HTML files
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    
    # Full security headers for HTML content
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}

# Security headers for service worker
location = /sw.js {
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
    add_header Service-Worker-Allowed "/" always;
    
    # Security headers for service worker
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
}

# Security headers for manifest
location = /manifest.json {
    add_header Cache-Control "public, max-age=86400" always;
    add_header X-Content-Type-Options "nosniff" always;
}

# Security headers for health check
location = /health {
    add_header Cache-Control "no-cache, no-store, must-revalidate" always;
    add_header Pragma "no-cache" always;
    add_header Expires "0" always;
}

# Remove server signature
server_tokens off;

# Hide nginx version
more_clear_headers Server;

# Security: Block access to sensitive files
location ~* \.(env|log|sql|bak|backup|old|tmp|temp|conf|config)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Security: Block access to hidden files
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

# Security: Block access to backup files
location ~ ~$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Security: Block access to package files
location ~* (package\.json|package-lock\.json|yarn\.lock|composer\.json|composer\.lock|\.git|\.svn|\.hg)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Security: Block access to source maps in production
location ~* \.map$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Security: Block access to IDE files
location ~* \.(vscode|idea|sublime|vim|emacs)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Security: Block access to documentation files
location ~* \.(md|txt|pdf|doc|docx|xls|xlsx|ppt|pptx)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Rate limiting headers
add_header X-RateLimit-Limit $limit_req_zone_name always;
add_header X-RateLimit-Remaining $limit_req_remaining always;
add_header X-RateLimit-Reset $limit_req_reset always;

# Custom security headers
add_header X-Powered-By "Performance Evaluation System" always;
add_header X-Server "VakifBank" always;

# Security: Prevent information disclosure
location ~* /(\.htaccess|\.htpasswd|\.user\.ini|\.git|\.svn|\.hg|\.bzr|\.cvs)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Security: Block access to system files
location ~* /(etc|proc|sys|var|tmp|temp|log|logs)/ {
    deny all;
    access_log off;
    log_not_found off;
}

# Security: Block access to database files
location ~* \.(db|sqlite|sqlite3|mdb|accdb)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Security: Block access to configuration files
location ~* \.(ini|conf|config|cfg|cnf)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Security: Block access to certificate files
location ~* \.(pem|crt|key|p12|pfx)$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Security: Block access to backup and archive files
location ~* \.(bak|backup|old|orig|save|swp|swo|tmp|temp|zip|tar|gz|rar|7z)$ {
    deny all;
    access_log off;
    log_not_found off;
}
